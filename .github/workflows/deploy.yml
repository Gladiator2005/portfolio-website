name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run migrations
      run: |
        python manage.py migrate --noinput
        
    - name: Create sample data (if no data exists)
      run: |
        python manage.py shell << 'EOF'
        from main.models import SiteConfiguration
        if not SiteConfiguration.objects.exists():
            config = SiteConfiguration.objects.create(
                site_title='Portfolio',
                name='Your Name',
                title='Full Stack Developer',
                bio='Welcome to my portfolio!',
                email='contact@example.com',
                projects_completed=0,
                years_experience=0,
                happy_clients=0,
                technologies_used=0
            )
            print("Created default site configuration")
        else:
            print("Site configuration already exists")
        EOF
        
    - name: Collect static files
      run: |
        python manage.py collectstatic --noinput --clear
        
    - name: Generate static HTML pages
      run: |
        python manage.py generate_static
        
    - name: Copy static files to docs
      run: |
        mkdir -p docs/static
        cp -r staticfiles/* docs/static/ 2>/dev/null || cp -r main/static/main/* docs/static/ 2>/dev/null || true
        if [ -d "media" ] && [ "$(ls -A media)" ]; then
          mkdir -p docs/media
          cp -r media/* docs/media/
        fi
        
    - name: Fix static paths in HTML
      run: |
        find docs -name "*.html" -type f -exec sed -i 's|/static/|static/|g' {} \;
        find docs -name "*.html" -type f -exec sed -i 's|href="/|href="|g' {} \;
        find docs -name "*.html" -type f -exec sed -i 's|href="projects/|href="./projects/|g' {} \;
        find docs -name "*.html" -type f -exec sed -i 's|href="about/|href="./about/|g' {} \;
        find docs -name "*.html" -type f -exec sed -i 's|href="contact/|href="./contact/|g' {} \;
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './docs'
        
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
